{% extends "./floorplan/floorplan.json" %}
{% from "./floorplan.json" import polygon_walls, floor_features %}
{% from "./relations.json" import to_ref_name, from_ref_name%}
{% import "./identifiers.json" as ids %}

{% macro pose_from_to(of, to) -%}
{
    "@id": "geor:{{ ids.pose_id(of, to) }}",
    "@type": "Pose",
    "of": "geom:{{of}}",
    "with-respect-to": "geom:{{to}}"
}
{%- endmacro %}

{% macro polygon_position(point_id, space) -%}
{
    "@id": "geor:{{ ids.position_id(point_id, space) }}",
    "@type": "Position",
    "of": "geom:{{ ids.shape_point_id(space, point_id) }}",
    "with-respect-to": "geom:{{ ids.space_point_id(space) }}"
}
{%- endmacro %}

{% macro wall_pose_to_space_ref_frame(space, wall_id) -%}
{
    "@id": "geor:{{ ids.wall_pose_id(wall_id, space) }}",
    "@type": "Pose",
    "of": "geom:{{ ids.wall_frame_id(space, wall_id) }}",
    "with-respect-to": "geom:{{ ids.space_frame_id(space) }}"
}
{%- endmacro %}

{% macro wall_corner_to_wall_ref_frame(space, wall_id, corner_id) -%}
{
    "@id": "geor:{{ ids.corner_position_id(corner_id, space, wall_id) }}",
    "@type": "Position",
    "of": "geom:{{ ids.wall_corner_point_id(space, wall_id, corner_id) }}",
    "with-respect-to": "geom:{{ ids.wall_frame_id(space, wall_id) }}"
}
{%- endmacro %}

{% block context %}
        {
            "geor": "https://comp-rob2b.github.io/metamodels/geometry/spatial-relations#",
            "geom": "https://comp-rob2b.github.io/metamodels/geometry/structural-entities#"
        },
        "https://comp-rob2b.github.io/metamodels/geometry/spatial-relations.json"
{% endblock%}

{% block space %}
{# Pose of the spaces as specificied in the model #}
{%- set to_f = to_ref_name(space.location.to_frame, space) %}
{%- set from_f = from_ref_name(space.location.from_frame) %}
{{ pose_from_to( to_f, from_f) }},
{# Positions of the Polygons to the center frame #} 
{%- for pc in space.get_shape().get_points(wrt=space.get_shape().get_frame()) %}
    {{ polygon_position(loop.index0, space) }},
{% endfor %}
{% endblock %}

{% block wall %}
{# Pose of the wall frames with regards to the space frame #}
{% set outer_loop = loop %}
{{ wall_pose_to_space_ref_frame(space, outer_loop.index0)}},
{% for i in [0,1,2,3] %}
{{ wall_corner_to_wall_ref_frame(space, outer_loop.index0, i)}}{%- if not loop.last %},
    {% endif %}
{% endfor %}{% if not loop.last %},
    {% endif %}
{% endblock %}
